# Информация о промптах

## Где находятся промпты

**Файл:** `backend/app/prompts.py`

## Какие промпты используются

### 1. Extractor (Извлечение воспоминаний)
**Назначение:** Извлекает структурированные воспоминания из текста пользователя

**Версии:**
- **v1** - базовая версия (используется по умолчанию)
- **v2** - улучшенная версия с фокусом на точность

**Что извлекает:**
- Воспоминания (summary, narrative)
- Персоны (persons) - **ВАЖНО: все упомянутые люди**
- Время (time_text)
- Место (location_text)
- Темы (topics)
- Важность (importance)
- Предложения глав (chapter_suggestions)

**Где используется:**
- При обработке каждого сообщения пользователя
- Вызывается автоматически в `service.py` → `_run_extractor()`

### 2. Planner (Планирование вопросов)
**Назначение:** Генерирует вопросы для заполнения пробелов в биографии

**Версии:**
- **v1** - базовая версия
- **v2** - улучшенная версия с фокусом на стратегические вопросы

**Что генерирует:**
- Вопросы (question_text)
- Причины (reason) - почему этот вопрос важен
- Уверенность (confidence)
- Целевой тип (target.type: person|chapter|memory|global)

**Где используется:**
- После обработки сообщения
- Вызывается автоматически в `service.py` → `_run_planner()`

## Как посмотреть результаты промптов

### 1. Через UI
1. Откройте **Sessions** → выберите сессию
2. Для каждого сообщения видны:
   - Extractor output (JSON)
   - Planner output
   - DB entities created

### 2. Через API
```bash
# Все промпт-раны для сессии
curl http://localhost:8000/api/prompt-runs?session_id=1

# Только extractor промпты
curl http://localhost:8000/api/prompt-runs?session_id=1&prompt_name=extractor

# Только planner промпты
curl http://localhost:8000/api/prompt-runs?session_id=1&prompt_name=planner

# Конкретный промпт-ран
curl http://localhost:8000/api/prompt-runs/10
```

### 3. Через страницу Prompt Runs
- Откройте **Prompt Runs** в левом меню
- Фильтруйте по:
  - prompt_name (extractor/planner)
  - parse_ok (успешно распарсилось или нет)
  - model
- Кликните "View" для детального просмотра

## Как изменить промпт

1. Откройте `backend/app/prompts.py`
2. Найдите нужный промпт в словаре `PROMPTS`
3. Измените текст промпта
4. Перезапустите бэкенд:
   ```bash
   docker-compose restart backend
   ```

## Как использовать другую версию промпта

### В UI:
- В форме отправки сообщения выберите версию из dropdown:
  - Extractor Version: v1 или v2
  - Planner Version: v1 или v2

### В API:
```bash
curl -X POST "http://localhost:8000/api/sessions/1/messages?extractor_version=v2&planner_version=v2" \
  -H "Content-Type: application/json" \
  -d '{"text":"Ваш текст"}'
```

## Текущая проблема: персоны не извлекаются

**Причина:** Промпт v1 недостаточно явно требует извлечения всех персон.

**Решение:** 
- Используйте улучшенный промпт v1 (уже обновлён)
- Или переключитесь на v2
- Или создайте новую версию v3 с ещё более явными инструкциями

## Как добавить новую версию промпта

1. Откройте `backend/app/prompts.py`
2. Добавьте новую версию:
```python
"extractor": {
    "v1": "...",
    "v2": "...",
    "v3": "..."  # новая версия
}
```
3. Перезапустите бэкенд
4. Новая версия появится в dropdown автоматически
