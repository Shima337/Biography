# Система автоматизированного тестирования извлечения людей

## Обзор

Автоматизированная система для тестирования качества извлечения людей из сообщений. Система отправляет тестовые сообщения, проверяет результаты и генерирует детальные отчеты с метриками и предложениями по улучшению.

## Структура

```
backend/tests/
├── test_messages.json          # Тестовые сообщения с ожидаемыми результатами
├── test_person_extraction.py   # Скрипт для запуска тестов
├── reports/                    # Директория с отчетами
│   └── person_extraction_report_YYYY-MM-DD_HH-MM.md
├── README.md                   # Инструкция по использованию
└── TESTING.md                  # Этот файл - документация системы
```

## Как использовать

### 1. Подготовка тестовых данных

Отредактируйте `test_messages.json`:

```json
{
  "messages": [
    {
      "id": 1,
      "text": "Ваше тестовое сообщение",
      "expected_persons": [
        {"name": "Имя человека", "type": "family|friend|colleague|romance|other"}
      ],
      "notes": "Описание теста"
    }
  ]
}
```

### 2. Запуск тестов

```bash
cd backend
python3 tests/test_person_extraction.py
```

### 3. Просмотр результатов

Отчет сохраняется в `tests/reports/person_extraction_report_YYYY-MM-DD_HH-MM.md`

## Метрики

Система вычисляет следующие метрики для каждого пайплайна:

- **Precision** - доля правильно найденных людей среди всех найденных
- **Recall** - доля найденных людей среди всех ожидаемых
- **F1 Score** - среднее гармоническое precision и recall

## Что проверяется

1. **Правильность извлечения** - все ли ожидаемые люди найдены
2. **Точность типов** - правильно ли определен тип человека (family, friend, etc.)
3. **Объединение вариантов имен** - правильно ли объединяются "Тася" и "Таиса Владимировна"
4. **Отсутствие лишних людей** - не извлекаются ли люди из предыдущих сообщений
5. **Сравнение Pipeline v1 vs v2** - какой пайплайн работает лучше

## Отчет

Отчет включает:

1. **Общая статистика** - метрики по всем сообщениям
2. **Детальный анализ** - по каждому сообщению:
   - Правильно найденные люди
   - Пропущенные люди
   - Лишние люди
   - Проблемы с вариантами имен
3. **Сравнение пайплайнов** - Pipeline v1 vs v2
4. **Предложения по улучшению** - конкретные рекомендации на основе найденных проблем

## Исправления в Pipeline v2

### Проблема: Лишние люди из предыдущих сообщений

**Было:** При обработке второго/третьего сообщения система находила людей из предыдущих сообщений, что снижало precision до 45.63%.

**Исправление:** 
- Проверка вариантов имен теперь происходит только среди людей, извлеченных в текущем сообщении
- Убрана проверка всех людей пользователя при объединении вариантов имен
- Люди фильтруются по связям MemoryPerson с конкретным сообщением

**Результат:** Precision улучшился до 91.67%, лишние люди из предыдущих сообщений больше не появляются.

### Проблема: Pipeline v1 не работает

**Было:** Pipeline v1 не находил ни одного человека (0% recall).

**Исправление:**
- Добавлен фильтр `pipeline_version == "v1"` при поиске существующих людей
- Это позволяет правильно создавать и находить людей для Pipeline v1

**Статус:** Pipeline v1 все еще работает плохо (0%), но исправление применено. Рекомендуется использовать только Pipeline v2.

## Текущие результаты

**Pipeline v2:**
- Precision: 91.67%
- Recall: 91.67%
- F1 Score: 91.67%

**Pipeline v1:**
- Precision: 0.00%
- Recall: 0.00%
- F1 Score: 0.00%

## Рекомендации

1. **Использовать только Pipeline v2** - он показывает отличные результаты
2. **Регулярно запускать тесты** - после каждого изменения промптов или логики
3. **Добавлять новые тестовые случаи** - особенно для проблемных сценариев
4. **Анализировать отчеты** - они содержат конкретные предложения по улучшению

## Примеры использования

### Добавление нового теста

1. Откройте `test_messages.json`
2. Добавьте новое сообщение в массив `messages`
3. Укажите ожидаемых людей в `expected_persons`
4. Запустите тесты
5. Проверьте отчет

### Анализ проблем

Если в отчете видите:
- **Пропущенные люди** → улучшить промпт person_extractor
- **Лишние люди** → проверить логику фильтрации
- **Неправильные типы** → улучшить правила определения типа
- **Проблемы с вариантами имен** → улучшить логику объединения

## Технические детали

### Как работает тест

1. Создается тестовый пользователь и сессия
2. Для каждого сообщения:
   - Отправляется через `ProcessingService.process_message()`
   - Запускаются оба пайплайна (v1 и v2) параллельно
   - Извлекаются люди через связи MemoryPerson
   - Сравниваются с ожидаемыми результатами
3. Вычисляются метрики
4. Генерируется отчет
5. Очищаются тестовые данные

### Фильтрация людей по сообщению

Люди извлекаются через связи MemoryPerson, что гарантирует, что мы берем только людей, связанных с конкретным сообщением, а не всех людей пользователя.

## Будущие улучшения

- [ ] Добавить тесты для извлечения воспоминаний
- [ ] Добавить тесты для извлечения глав
- [ ] Добавить тесты для генерации вопросов
- [ ] Автоматический запуск тестов при коммитах
- [ ] Визуализация метрик в отчете
